<!DOCTYPE html>
<html>

<head>
    <title>Áî®Êà∑Ê≥®ÂÜå</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <style>
        .register-page {
            background-image: linear-gradient(180deg, #2af598 0%, #009efd 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .register-title {
            font-size: 20px;
            color: #409EFF;
        }

        .box-card {
            width: 420px;
        }

        .login-link {
            float: right;
            margin-top: 10px;
        }
    </style>
</head>

<body>
<div id="app">
    <div class="register-page">
        <el-card class="box-card">
            <div slot="header" class="clearfix">
                <span class="register-title">üìù Áî®Êà∑Ê≥®ÂÜå</span>
            </div>
            <div class="register-form">
                <el-form :model="form" :rules="registerRules" ref="registerForm">
                    <el-form-item prop="username">
                        <el-input v-model="form.username" placeholder="4-16‰ΩçÂ≠óÊØç/Êï∞Â≠ó/‰∏ãÂàíÁ∫ø" clearable>
                            <template slot="prepend"><i class="el-icon-user"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="password">
                        <el-input type="password" v-model="form.password" placeholder="6-16‰ΩçÔºåÂøÖÈ°ªÂåÖÂê´Â≠óÊØçÂíåÊï∞Â≠ó" show-password>
                            <template slot="prepend"><i class="el-icon-lock"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="confirmPassword">
                        <el-input type="password" v-model="form.confirmPassword" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å"
                                  show-password>
                            <template slot="prepend"><i class="el-icon-check"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="phone">
                        <el-input v-model="form.phone" placeholder="ÁîµËØùÂè∑Á†Å" clearable>
                            <template slot="prepend"><i class="el-icon-phone"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="email">
                        <el-input v-model="form.email" placeholder="ÈÇÆÁÆ±Âú∞ÂùÄ" clearable>
                            <template slot="prepend"><i class="el-icon-message"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="captcha">
                        <div style="display: flex;">
                            <el-input v-model="form.captcha" placeholder="ËØ∑ËæìÂÖ•È™åËØÅÁ†Å" style="width: 70%;" clearable>
                                <template slot="prepend"><i class="el-icon-key"></i></template>
                            </el-input>
                            <img :src="captchaUrl" @click="refreshCaptcha" style="margin-left: 10px; height: 40px; cursor: pointer;" title="ÁÇπÂáªÂà∑Êñ∞">
                        </div>
                    </el-form-item>


                    <el-form-item>
                        <el-button
                                style="width:100%;"
                                type="primary"
                                @click="handleRegister()"
                                :loading="loading">
                            Á´ãÂç≥Ê≥®ÂÜå
                        </el-button>
                    </el-form-item>
                </el-form>

                <div class="login-link" style="margin-top: 15px; text-align: center;">
                    <el-link type="primary" href="login.html">Â∑≤ÊúâË¥¶Âè∑ÔºüÂéªÁôªÂΩï</el-link>
                </div>

            </div>
        </el-card>
    </div>
</div>

<script>
    Vue.use(ELEMENT);

    new Vue({
        el: '#app',
        data() {

            // ÂØÜÁ†ÅÂº∫Â∫¶È™åËØÅÔºà6-16‰ΩçÂ≠óÊØç+Êï∞Â≠óÔºâ
            const validatePassword = (rule, value, callback) => {
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,16}$/.test(value)) {
                    callback(new Error('6-16‰ΩçÔºåÂøÖÈ°ªÂåÖÂê´Â≠óÊØçÂíåÊï∞Â≠ó'));
                } else {
                    callback();
                }
            };

            // Á°ÆËÆ§ÂØÜÁ†ÅÈ™åËØÅ
            const validateConfirm = (rule, value, callback) => {
                if (value !== this.form.password) {
                    callback(new Error('‰∏§Ê¨°ËæìÂÖ•ÂØÜÁ†Å‰∏ç‰∏ÄËá¥'));
                } else {
                    callback();
                }
            };

            // ÊâãÊú∫Âè∑È™åËØÅ
            const validatePhone = (rule, value, callback) => {
                if (!/^1[3-9]\d{9}$/.test(value)) {
                    callback(new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊâãÊú∫Âè∑Á†Å'));
                } else {
                    callback();
                }
            };

            // ÈÇÆÁÆ±È™åËØÅ
            const validateEmail = (rule, value, callback) => {
                if (!/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/.test(value)) {
                    callback(new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄ'));
                } else {
                    callback();
                }
            };

            return {


                form: {
                    username: '',
                    password: '',
                    confirmPassword: '',
                    phone: '',
                    email: '',
                    captcha: '',
                },

                captchaUrl: 'http://localhost:8080/chess_war/user/getCaptcha?' + new Date().getTime(),

                loading: false,

                registerRules: {
                    username: [
                        {required: true, message: 'Áî®Êà∑Âêç‰∏çËÉΩ‰∏∫Á©∫', trigger: 'blur'},
                        {min: 4, max: 16, message: 'ÈïøÂ∫¶Âú®4Âà∞16‰∏™Â≠óÁ¨¶', trigger: 'blur'},
                        {pattern: /^[a-zA-Z0-9_]+$/, message: 'Âè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫ø'}
                    ],
                    password: [
                        {required: true, message: 'ÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫', trigger: 'blur'},
                        {validator: validatePassword, trigger: 'blur'}
                    ],
                    confirmPassword: [
                        {required: true, message: 'ËØ∑Á°ÆËÆ§ÂØÜÁ†Å', trigger: 'blur'},
                        {validator: validateConfirm, trigger: 'blur'}
                    ],
                    phone: [
                        {required: true, message: 'ÊâãÊú∫Âè∑‰∏çËÉΩ‰∏∫Á©∫', trigger: 'blur'},
                        {validator: validatePhone, trigger: 'blur'}
                    ],
                    email: [
                        {required: true, message: 'ÈÇÆÁÆ±‰∏çËÉΩ‰∏∫Á©∫', trigger: 'blur'},
                        {validator: validateEmail, trigger: 'blur'}
                    ]
                }
            }
        },

        methods: {
            refreshCaptcha() {
                this.captchaUrl = 'http://localhost:8080/chess_war/user/getCaptcha?' + new Date().getTime();
            },
            handleRegister() {
                this.$refs.registerForm.validate(valid => {
                    if (valid) {
                        this.loading = true;
                        // ÂáÜÂ§áÊ≥®ÂÜåÊï∞ÊçÆ
                        const params = new URLSearchParams();
                        params.append('username', this.form.username);
                        params.append('password', this.form.password);
                        params.append('phone', this.form.phone);
                        params.append('email', this.form.email);
                        params.append('captcha', this.form.captcha);
                        axios.post("http://localhost:8080/chess_war/user/register", params,{
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        })
                            .then(req => {
                                if (req.data === 'success') {
                                    this.showMessage('ÊÅ≠Âñú‰Ω†ÔºåÊ≥®ÂÜåÊàêÂäü', 'success');
                                    setTimeout(() => {
                                        window.location.href = 'login.html';
                                    }, 2000);

                                } else if (req.data === 'exist') {
                                    this.showMessage('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®', 'warning')
                                } else if (req.data === 'error') {
                                    this.showMessage('Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error')
                                } else if (req.data === 'empty'){
                                    this.showMessage('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊ≥®ÂÜå‰ø°ÊÅØ', 'warning')
                                } else if (req.data === 'email'){
                                    this.showMessage('ÈÇÆÁÆ±Ê†ºÂºèÂ∑≤Ë¢´Ê≥®ÂÜå', 'warning')
                                }else if (req.data === 'phone'){
                                    this.showMessage('ÊâãÊú∫Âè∑Â∑≤Ë¢´Ê≥®ÂÜå', 'warning')
                                }else if (req.data === 'captcha') {
                                    this.showMessage('È™åËØÅÁ†ÅÈîôËØØ', 'warning');
                                    this.refreshCaptcha();
                                }
                            }).catch(error => {
                                console.log(error);
                                this.showMessage('Ê≥®ÂÜåÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï', 'error')
                            })
                            .finally(() => {
                                this.loading = false;
                            });
                    } else {
                        this.showMessage('ËØ∑Â°´ÂÜôÊ≠£Á°ÆÁöÑÊ≥®ÂÜå‰ø°ÊÅØ', 'warning')
                    }
                });
            },
            showMessage(message, type){
                this.$message({
                    showClose: true,
                    message: message,
                    type: type
                });
            }
        }
    });
</script>
</body>
</html>