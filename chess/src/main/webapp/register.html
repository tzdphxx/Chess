<!DOCTYPE html>
<html>

<head>
    <title>ç”¨æˆ·æ³¨å†Œ</title>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <style>
        .register-page {
            background-image: linear-gradient(180deg, #2af598 0%, #009efd 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .register-title {
            font-size: 20px;
            color: #409EFF;
        }

        .box-card {
            width: 420px;
        }

        .login-link {
            float: right;
            margin-top: 10px;
        }
    </style>
</head>

<body>
<div id="app">
    <div class="register-page">
        <el-card class="box-card">
            <div slot="header" class="clearfix">
                <span class="register-title">ğŸ“ ç”¨æˆ·æ³¨å†Œ</span>
            </div>
            <div class="register-form">
                <el-form :model="form" :rules="registerRules" ref="registerForm">
                    <el-form-item prop="username">
                        <el-input v-model="form.username" placeholder="4-16ä½å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿" clearable>
                            <template slot="prepend"><i class="el-icon-user"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="password">
                        <el-input type="password" v-model="form.password" placeholder="6-16ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—" show-password>
                            <template slot="prepend"><i class="el-icon-lock"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="confirmPassword">
                        <el-input type="password" v-model="form.confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                                  show-password>
                            <template slot="prepend"><i class="el-icon-check"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="phone">
                        <el-input v-model="form.phone" placeholder="ç”µè¯å·ç " clearable>
                            <template slot="prepend"><i class="el-icon-phone"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="email">
                        <el-input v-model="form.email" placeholder="é‚®ç®±åœ°å€" clearable>
                            <template slot="prepend"><i class="el-icon-message"></i></template>
                        </el-input>
                    </el-form-item>

                    <el-form-item prop="captcha">
                        <div style="display: flex;">
                            <el-input v-model="form.captcha" placeholder="è¯·è¾“å…¥éªŒè¯ç " style="width: 70%;" clearable>
                                <template slot="prepend"><i class="el-icon-key"></i></template>
                            </el-input>
                            <img :src="captchaUrl" @click="refreshCaptcha" style="margin-left: 10px; height: 40px; cursor: pointer;" title="ç‚¹å‡»åˆ·æ–°">
                        </div>
                    </el-form-item>


                    <el-form-item>
                        <el-button
                                style="width:100%;"
                                type="primary"
                                @click="handleRegister()"
                                :loading="loading">
                            ç«‹å³æ³¨å†Œ
                        </el-button>
                    </el-form-item>
                </el-form>

                <div class="login-link" style="margin-top: 15px; text-align: center;">
                    <el-link type="primary" href="login.html">å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•</el-link>
                </div>

            </div>
        </el-card>
    </div>
</div>

<script>
    Vue.use(ELEMENT);

    new Vue({
        el: '#app',
        data() {

            // å¯†ç å¼ºåº¦éªŒè¯ï¼ˆ6-16ä½å­—æ¯+æ•°å­—ï¼‰
            const validatePassword = (rule, value, callback) => {
                if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,16}$/.test(value)) {
                    callback(new Error('6-16ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—'));
                } else {
                    callback();
                }
            };

            // ç¡®è®¤å¯†ç éªŒè¯
            const validateConfirm = (rule, value, callback) => {
                if (value !== this.form.password) {
                    callback(new Error('ä¸¤æ¬¡è¾“å…¥å¯†ç ä¸ä¸€è‡´'));
                } else {
                    callback();
                }
            };

            // æ‰‹æœºå·éªŒè¯
            const validatePhone = (rule, value, callback) => {
                if (!/^1[3-9]\d{9}$/.test(value)) {
                    callback(new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·ç '));
                } else {
                    callback();
                }
            };

            // é‚®ç®±éªŒè¯
            const validateEmail = (rule, value, callback) => {
                if (!/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/.test(value)) {
                    callback(new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€'));
                } else {
                    callback();
                }
            };

            return {


                form: {
                    username: '',
                    password: '',
                    confirmPassword: '',
                    phone: '',
                    email: '',
                    captcha: '',
                },

                captchaUrl: 'http://localhost:8080/chess_war/user/getCaptcha?' + new Date().getTime(),

                loading: false,

                registerRules: {
                    username: [
                        {required: true, message: 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º', trigger: 'blur'},
                        {min: 4, max: 16, message: 'é•¿åº¦åœ¨4åˆ°16ä¸ªå­—ç¬¦', trigger: 'blur'},
                        {pattern: /^[a-zA-Z0-9_]+$/, message: 'åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿'}
                    ],
                    password: [
                        {required: true, message: 'å¯†ç ä¸èƒ½ä¸ºç©º', trigger: 'blur'},
                        {validator: validatePassword, trigger: 'blur'}
                    ],
                    confirmPassword: [
                        {required: true, message: 'è¯·ç¡®è®¤å¯†ç ', trigger: 'blur'},
                        {validator: validateConfirm, trigger: 'blur'}
                    ],
                    phone: [
                        {required: true, message: 'æ‰‹æœºå·ä¸èƒ½ä¸ºç©º', trigger: 'blur'},
                        {validator: validatePhone, trigger: 'blur'}
                    ],
                    email: [
                        {required: true, message: 'é‚®ç®±ä¸èƒ½ä¸ºç©º', trigger: 'blur'},
                        {validator: validateEmail, trigger: 'blur'}
                    ]
                }
            }
        },

        methods: {
            refreshCaptcha() {
                this.captchaUrl = 'http://localhost:8080/chess_war/user/getCaptcha?' + new Date().getTime();
            },
            handleRegister() {
                this.$refs.registerForm.validate(valid => {
                    if (valid) {
                        this.loading = true;
                        // å‡†å¤‡æ³¨å†Œæ•°æ®
                        const params = new URLSearchParams();
                        params.append('username', this.form.username);
                        params.append('password', this.form.password);
                        params.append('phone', this.form.phone);
                        params.append('email', this.form.email);
                        params.append('captcha', this.form.captcha);
                        axios.post("http://localhost:8080/chess_war/user/register", params,{
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            }
                        })
                            .then(req => {
                                if (req.data === 'success') {
                                    this.showMessage('æ­å–œä½ ï¼Œæ³¨å†ŒæˆåŠŸ', 'success');
                                    setTimeout(() => {
                                        window.location.href = 'login.html';
                                    }, 2000);

                                } else if (req.data === 'exist') {
                                    this.showMessage('ç”¨æˆ·åå·²å­˜åœ¨', 'warning')
                                } else if (req.data === 'error') {
                                    this.showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error')
                                } else if (req.data === 'empty'){
                                    this.showMessage('è¯·å¡«å†™å®Œæ•´çš„æ³¨å†Œä¿¡æ¯', 'warning')
                                } else if (req.data === 'email'){
                                    this.showMessage('é‚®ç®±æ ¼å¼å·²è¢«æ³¨å†Œ', 'warning')
                                }else if (req.data === 'phone'){
                                    this.showMessage('æ‰‹æœºå·å·²è¢«æ³¨å†Œ', 'warning')
                                }else if (req.data === 'captcha') {
                                    this.showMessage('éªŒè¯ç é”™è¯¯', 'warning');
                                    this.refreshCaptcha();
                                }
                            }).catch(error => {
                                console.log(error);
                                this.showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'error')
                            })
                            .finally(() => {
                                this.loading = false;
                            });
                    } else {
                        this.showMessage('è¯·å¡«å†™æ­£ç¡®çš„æ³¨å†Œä¿¡æ¯', 'warning')
                    }
                });
            },
            showMessage(message, type){
                this.$message({
                    showClose: true,
                    message: message,
                    type: type
                });
            }
        }
    });
</script>
</body>
</html>