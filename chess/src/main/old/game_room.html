<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>五子棋</title>


    <style>
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f5f5f5;
        }
        #screen {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        #chess {
            background-color: #f9e9c3;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
    </style>

</head>
<body>

<div class="game-container">
    <div id="screen">等待游戏开始...</div>
    <canvas id="chess" width="450" height="450"></canvas>
</div>

<script>
    let gameInfo = {
        roomId:null,
        thisUserId:null,
        thatUserId:null,
        isWhite:true,
        currentTurn:null,
    };
    let chess = document.getElementById('chess');
    let context = chess.getContext('2d');
    let chessBoard = [];
    let me = false;
    let over = false;
    let heartbeatInterval = null;
    let reconnectingCount = 0;
    const MAX_RECONNECT_TIME = 5;
    let webSocket = null;
    //初始化数组
    for (let i = 0; i < 15; i++){
        chessBoard[i] = [];
        for (let j = 0; j < 15; j++){
            chessBoard[i][j] = 0;
        }
    }

    function setScreenText(me) {
        let screen = document.querySelector("#screen");
        if (me){
            screen.innerHTML = "轮到你落子了！";
        }else {
            screen.innerHTML = "轮到对方落子了！";
        }
    }

    //棋盘背景
    function drawChessboardBackground() {
        // 清空画布
        context.clearRect(0, 0, chess.width, chess.height);

        // 设置棋盘背景色
        context.fillStyle = "#f9e9c3";
        context.fillRect(0, 0, 450, 450);

        // 绘制棋盘网格
        initChessBoard();
    }

    //初始化
    function initGame() {
        me = gameInfo.isWhite;

        context.strokeStyle = "#BFBFBF";


        drawChessboardBackground();

    }
    
    
    function initChessBoard() {
        context.strokeStyle = "#BFBFBF";
        context.lineWidth = 1;


        for (let i = 0; i < 15; i++){
            context.beginPath();
            context.moveTo(15 + i * 30, 15);
            context.lineTo(15 + i * 30, 435);
            context.stroke();

            context.closePath();
            context.beginPath();

            context.moveTo(15, 15 + i * 30);
            context.lineTo(435, 15 + i * 30);
            context.stroke();
            context.closePath();
        }
    }

    //绘制棋子
    function oneStep(i, j, isWhite) {
        context.beginPath();
        context.arc(15 + i * 30, 15 + j * 30, 13, 0, Math.PI * 2);
        context.closePath();
        var gradient = context.createLinearGradient(15 + i * 30 - 2, 15 + j * 30 - 2, 0, 15 + i * 30, 15 + j * 30 , 13);
        if (!isWhite){
            gradient.addColorStop(0, "#636766");
            gradient.addColorStop(1, "#0A0A0A");
        }else {
            gradient.addColorStop(0, "#F9F9F9");
            gradient.addColorStop(1, "#D1D1D1");
        }
        context.fillStyle = gradient;
        context.fill();
    }





    function connect() {

        if (reconnectingCount >= MAX_RECONNECT_TIME) {
            alert('连接失败，返回大厅');
            location.href = '../webapp/game_hall.html';
            return;
        }

            webSocket = new WebSocket('ws://' + location.host + '/chess_war/game');


        // 连接成功后发送初始化请求
        webSocket.onopen = function (event) {
            console.log('连接建立');
            // 主动请求最新游戏状态
            const initRequest = {
                type: "init",
                chessBoard: gameInfo.chessBoard,
                userId: gameInfo.thisUserId,
                roomId: gameInfo.roomId
            };
            webSocket.send(JSON.stringify(initRequest));
            startHeartbeat();
        };

        // 强化连接关闭处理
        webSocket.onclose = function (event) {
            console.log('连接关闭', event.code, event.reason);
            stopHeartbeat();

            // 非主动关闭时重连
            if (event.code !== 1000 && reconnectingCount < MAX_RECONNECT_TIME) {
                reconnectingCount++;
                const delay = Math.min(5000, 1000 * reconnectingCount); // 渐进延迟
                console.log(`尝试重新连接 (${reconnectingCount}/5) 延迟:${delay}ms`);
                setTimeout(connect, delay);
            } else {
                alert('连接已断开，返回大厅');
                location.assign('../webapp/game_hall.html');
            }
        };


        webSocket.onerror = function () {
            console.log('连接错误');
            stopHeartbeat();
            alert('与服务器断开连接，返回大厅...');
            location.assign('../webapp/game_hall.html');
        };

        webSocket.onmessage = function (event) {

            const response = JSON.parse(event.data);

            // 处理初始化响应
            if (response.type === "init") {
                console.log("收到初始化响应:", response);
                // 同步棋盘状态
                if (response.chessBoard) {
                    chessBoard = response.chessBoard;
                    redrawChessBoard();
                }
                gameInfo.currentTurn = response.currentTurn;
                me = (gameInfo.currentTurn === gameInfo.thisUserId);
                setScreenText(me);
            }



            if (response.type === "heartbeat") {
                console.log("收到心跳响应");
                return;
            }

            if (response.type === "gameReady") {
                console.log("handlerGameReady: " + event.data);
                gameInfo.roomId = response.roomId;
                gameInfo.thisUserId = response.thisUserId;
                gameInfo.thatUserId = response.thatUserId;
                gameInfo.isWhite = (response.whiteUserId === gameInfo.thisUserId);
                console.log('[gameReady] ' + JSON.stringify(gameInfo));

                drawChessboardBackground();


                let initRequest = {
                    type: "init",
                    userId: gameInfo.thisUserId,
                };
                webSocket.send(JSON.stringify(initRequest));

                gameInfo.currentTurn = response.whiteUserId;
                me = (gameInfo.currentTurn === gameInfo.thisUserId);
                setScreenText(me);


            } else if (response.type === "putChess") {
                console.log("handlerPutChess: " + event.data);
                if (response.type === "error") {
                    console.error('服务器错误: ' + response.reason);
                    alert(response.reason || '操作失败');
                    return;
                }

                if (response.userId === gameInfo.thisUserId) {
                    oneStep(response.col, response.row, gameInfo.isWhite);
                    chessBoard[response.row][response.col] = gameInfo.isWhite ? 1 : 2;
                } else if (response.userId === gameInfo.thatUserId) {
                    oneStep(response.col, response.row, !gameInfo.isWhite);
                    chessBoard[response.row][response.col] = gameInfo.isWhite ? 2 : 1;
                } else {
                    console.log('[putChess] response userId 错误 response = ' + JSON.stringify(response));
                    return;
                }

                if (response.nextTurn) {
                    gameInfo.currentTurn = response.nextTurn;
                    console.log('下一个玩家: ' + response.nextTurn);
                    me = (gameInfo.currentTurn === gameInfo.thisUserId);
                } else {
                    me = !me;
                }

                if (response.winner != 0) {
                    over = true;
                    if (response.winner === gameInfo.thisUserId) {
                        alert('你赢了');
                    } else {
                        alert("你输了")
                    }
                    setTimeout(() => {
                        location.assign('../webapp/game_hall.html');
                    }, 2000);
                    return;
                }
                setScreenText(me);
            }
        };
    }


    //心跳机制
    function startHeartbeat() {
        heartbeatInterval = setInterval(() => {
            if (webSocket?.readyState === WebSocket.OPEN) {
                webSocket.send(JSON.stringify({ type: "heartbeat" }));
            }
        }, 3000);
    }


    function redrawChessBoard() {
        drawChessboardBackground();
        for (let i = 0; i < 15; i++) {
            for (let j = 0; j < 15; j++) {
                if (chessBoard[i][j] !== 0) {
                    const isWhite = chessBoard[i][j] === 1;
                    oneStep(j, i, isWhite);
                }
            }
        }
    }




    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    // 连接
    connect();

    window.onbeforeunload = function () {
        stopHeartbeat();
        if (webSocket){
            webSocket.close();
        }
    };




    chess.onclick = function (e) {
        if (over) {
            return;
        }
        if (!me){
            return;
        }
        if (webSocket.readyState != WebSocket.OPEN) {
            alert('连接已断开')
            return;
        }
        let x = e.offsetX;
        let y = e.offsetY;
        let col = Math.round((x - 15)/30);
        let row = Math.round((y - 15)/30);

        if (col < 0|| col >= 15|| row < 0|| row >= 15){
            return;
        }
        if (chessBoard[row][col]===0){
            send(row,col);
        }
    };

    function send(row, col) {
        console.log("落子在"+row+"行"+col+"列");
        let request = {
            type: "putChess",
            userId: gameInfo.thisUserId,
            row: row,
            col: col
        };
        webSocket.send(JSON.stringify(request));
    }
</script>
</body>
</html>